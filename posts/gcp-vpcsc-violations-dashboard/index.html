<!doctype html><html lang=en><head><title>GCP VPC Service Controls Dashboard · Vijay Thakorlal's Blog
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Vijay Thakorlal"><meta name=description content="Lorenzo Caggioni has a great blog post on how to visualise VPC Service Controls violations using Big Query and Looker Studio (formerly Data Studio). The dashboard is super useful for understanding which services, identities or GCP projects are generating the most violations. This makes it easier to determine where to start focusing your efforts in addressing the violations.
This short post provides the terraform code to:
Create the log sink to Big Query for VPC SC."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="GCP VPC Service Controls Dashboard"><meta name=twitter:description content="Lorenzo Caggioni has a great blog post on how to visualise VPC Service Controls violations using Big Query and Looker Studio (formerly Data Studio). The dashboard is super useful for understanding which services, identities or GCP projects are generating the most violations. This makes it easier to determine where to start focusing your efforts in addressing the violations.
This short post provides the terraform code to:
Create the log sink to Big Query for VPC SC."><meta property="og:title" content="GCP VPC Service Controls Dashboard"><meta property="og:description" content="Lorenzo Caggioni has a great blog post on how to visualise VPC Service Controls violations using Big Query and Looker Studio (formerly Data Studio). The dashboard is super useful for understanding which services, identities or GCP projects are generating the most violations. This makes it easier to determine where to start focusing your efforts in addressing the violations.
This short post provides the terraform code to:
Create the log sink to Big Query for VPC SC."><meta property="og:type" content="article"><meta property="og:url" content="https://vijayjt.github.io/posts/gcp-vpcsc-violations-dashboard/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-25T08:10:04+00:00"><meta property="article:modified_time" content="2024-02-25T08:10:04+00:00"><link rel=canonical href=https://vijayjt.github.io/posts/gcp-vpcsc-violations-dashboard/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.e1bdf152d93b060b06ba5d496486ed9c201a8b95d335e035beb5faebe3b61cad.css integrity="sha256-4b3xUtk7BgsGul1JZIbtnCAai5XTNeA1vrX66+O2HK0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Vijay Thakorlal's Blog
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://vijayjt.github.io/posts/gcp-vpcsc-violations-dashboard/>GCP VPC Service Controls Dashboard</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-02-25T08:10:04Z>February 25, 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/google/>Google</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/cloud/>Cloud</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/gcp/>Gcp</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/vpcsc/>Vpcsc</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/bigquery/>Bigquery</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/looker/>Looker</a></span></div></div></header><div class=post-content><p><a href=https://medium.com/@lcaggio class=external-link target=_blank rel=noopener>Lorenzo Caggioni</a> has a great blog <a href=https://medium.com/google-cloud/create-a-data-studio-dashboard-to-monitor-vpc-sc-violations-on-your-google-cloud-organization-bf8f3bead691 class=external-link target=_blank rel=noopener>post</a> on how to visualise VPC Service Controls violations using Big Query and Looker Studio (formerly Data Studio). The dashboard is super useful for understanding which services, identities or GCP projects are generating the most violations. This makes it easier to determine where to start focusing your efforts in addressing the violations.</p><p>This short post provides the terraform code to:</p><ul><li>Create the log sink to Big Query for VPC SC.</li><li>Create a table to use for the dashboard.</li></ul><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Terraform data-lang=Terraform><span style=display:flex><span><span style=color:#ff7b72>variable</span> <span style=color:#a5d6ff>&#34;gcp_org_id&#34;</span> {
</span></span><span style=display:flex><span>  type        = string
</span></span><span style=display:flex><span>  description = <span style=color:#a5d6ff>&#34;The GCP Organization ID&#34;</span>
</span></span><span style=display:flex><span>  default     = <span style=color:#a5d6ff>&#34;changme&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>locals { 
</span></span><span style=display:flex><span>  bq_project = <span style=color:#a5d6ff>&#34;changeme&#34;</span>
</span></span><span style=display:flex><span>  org_service_account = <span style=color:#a5d6ff>&#34;service-org-</span><span style=color:#a5d6ff>${</span>var.gcp_org_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>@gcp-sa-logging.iam.gserviceaccount.com&#34;</span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>  # You can customise this filter to only show logs for specific services
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  base_filter = <span style=color:#ff7b72;font-weight:700>&lt;&lt;EOF</span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>protoPayload.@type=&#34;type.googleapis.com/google.cloud.audit.AuditLog&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>protoPayload.metadata.@type=&#34;type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff></span><span style=color:#ff7b72;font-weight:700>EOF</span>
</span></span><span style=display:flex><span>}<span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Create an org level log sink
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;google_logging_organization_sink&#34;</span> <span style=color:#a5d6ff>&#34;bq_log_sink&#34;</span> {
</span></span><span style=display:flex><span>  name   = <span style=color:#a5d6ff>&#34;vpcsc-bq-sink&#34;</span>
</span></span><span style=display:flex><span>  org_id = var.gcp_org_id<span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>  # &#34;bigquery.googleapis.com/projects/[PROJECT_ID]/datasets/[DATASET]&#34;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  destination = <span style=color:#a5d6ff>&#34;bigquery.googleapis.com/</span><span style=color:#a5d6ff>${</span>google_bigquery_dataset.vpcsc_violations_dataset.id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  filter = trimspace(local.base_filter)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  bigquery_options {
</span></span><span style=display:flex><span>    use_partitioned_tables = <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  include_children = <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>}<span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># This permission is required as documented here https://cloud.google.com/logging/docs/export/configure_export_v2#dest-auth
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Grant the org level service account the Big Query editor role
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;google_bigquery_dataset_iam_member&#34;</span> <span style=color:#a5d6ff>&#34;vpcsc_violations_dataset&#34;</span> {
</span></span><span style=display:flex><span>  dataset_id = google_bigquery_dataset.vpcsc_violations_dataset.dataset_id
</span></span><span style=display:flex><span>  role       = <span style=color:#a5d6ff>&#34;roles/bigquery.dataEditor&#34;</span>
</span></span><span style=display:flex><span>  member     = <span style=color:#a5d6ff>&#34;serviceAccount:</span><span style=color:#a5d6ff>${</span>local.org_service_account<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Create a BQ Data set where the log sink will export VPC SC logs
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># This will then be visualised in Looker / Data Studio
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;google_bigquery_dataset&#34;</span> <span style=color:#a5d6ff>&#34;vpcsc_violations_dataset&#34;</span> {
</span></span><span style=display:flex><span>  dataset_id    = <span style=color:#a5d6ff>&#34;vpsc_violations_data&#34;</span>
</span></span><span style=display:flex><span>  friendly_name = <span style=color:#a5d6ff>&#34;vpsc-violations-data&#34;</span>
</span></span><span style=display:flex><span>  description   = <span style=color:#a5d6ff>&#34;VPC Service Control Violations Data&#34;</span>
</span></span><span style=display:flex><span>  location      = <span style=color:#a5d6ff>&#34;EU&#34;</span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>  # Make a group (or it could be a user but the former is preferred) the owner of the data set
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  access {
</span></span><span style=display:flex><span>    role           = <span style=color:#a5d6ff>&#34;OWNER&#34;</span>
</span></span><span style=display:flex><span>    group_by_email = <span style=color:#a5d6ff>&#34;mygroup@acme.com&#34;</span>
</span></span><span style=display:flex><span>  }<span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>  # Grant the org service account writer permissions
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  access {
</span></span><span style=display:flex><span>    role          = <span style=color:#a5d6ff>&#34;WRITER&#34;</span>
</span></span><span style=display:flex><span>    user_by_email = local.org_service_account
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  access {
</span></span><span style=display:flex><span>    role           = <span style=color:#a5d6ff>&#34;READER&#34;</span>
</span></span><span style=display:flex><span>    group_by_email = <span style=color:#a5d6ff>&#34;anothergroup@acme.com&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Create a table from a view - this extracts nested fields from 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># the field protopayload_auditlog.metadataJson 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># this makes it easier to show information from this field in Data Studio/Looker charts
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;google_bigquery_table&#34;</span> <span style=color:#a5d6ff>&#34;cleaned_vpcsc_violations_table&#34;</span> {
</span></span><span style=display:flex><span>  dataset_id = google_bigquery_dataset.vpcsc_violations_dataset.dataset_id
</span></span><span style=display:flex><span>  table_id   = <span style=color:#a5d6ff>&#34;cleaned_vpcsc_violations_table&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  view {
</span></span><span style=display:flex><span>    query = templatefile(<span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span>path.module<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/vpcsc-violations-bq-table.tpl&#34;</span>, {
</span></span><span style=display:flex><span>      project = local.bq_project
</span></span><span style=display:flex><span>      dataset = google_bigquery_dataset.vpcsc_violations_dataset.dataset_id
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    use_legacy_sql = <span style=color:#79c0ff>false</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here is some example SQL to create the table view:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72;font-weight:700>*</span>,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>CASE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>WHEN</span><span style=color:#6e7681> </span>REGEXP_CONTAINS(protopayload_auditlog.status.message,<span style=color:#a5d6ff>&#39;(Dry Run Mode)*&#39;</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>THEN</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;Dry Run&#39;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>ELSE</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;Enforced&#39;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>END</span><span style=color:#6e7681> </span>enforced_type,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>CASE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>WHEN</span><span style=color:#6e7681> </span>REGEXP_CONTAINS(protopayload_auditlog.requestMetadata.callerIp,<span style=color:#6e7681> </span>r<span style=color:#a5d6ff>&#34;(^127\.)|(^10\.)|(^172\.1[6-9]\.)|(^172\.2[0-9]\.)|(^172\.3[0-1]\.)|(^192\.168\.)&#34;</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>OR</span><span style=color:#6e7681> </span>protopayload_auditlog.requestMetadata.callerIp<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;private&#39;</span><span style=color:#6e7681> </span><span style=color:#ff7b72>THEN</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>ELSE</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>0</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>END</span><span style=color:#6e7681> </span>internal_ip,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>REGEXP_EXTRACT(protopayload_auditlog.metadataJson,<span style=color:#6e7681> </span>r<span style=color:#a5d6ff>&#39;servicePerimeterName&#34;:&#34;[a-zA-Z]+\/[\d]+\/[a-zA-Z]+\/([a-zA-Z_]+)&#39;</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>as</span><span style=color:#6e7681> </span>perimeter,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>REGEXP_EXTRACT(protopayload_auditlog.metadataJson,<span style=color:#6e7681> </span>r<span style=color:#a5d6ff>&#39;violationReason&#34;:&#34;([a-zA-Z_]+)&#39;</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>as</span><span style=color:#6e7681> </span>violation_reason,<span style=color:#6e7681>    
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> 
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72;font-weight:700>`</span><span style=color:#f85149>${</span>project<span style=color:#f85149>}</span>.<span style=color:#f85149>${</span>dataset<span style=color:#f85149>}</span>.cloudaudit_googleapis_com_policy<span style=color:#ff7b72;font-weight:700>`</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>This is the same example query that Lorenzo provides in hist post - the only change is to permit underscores in the RegEx for the perimeter.</p><p>The Google <a href=https://cloud.google.com/vpc-service-controls/docs/enable#analyze-violations class=external-link target=_blank rel=noopener>documentation</a> also have their own example:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>receiveTimestamp,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span>time<span style=color:#6e7681> </span><span style=color:#ff7b72>of</span><span style=color:#6e7681> </span>violation<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>Resource.labels.service,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span>protected<span style=color:#6e7681> </span>Google<span style=color:#6e7681> </span>Cloud<span style=color:#6e7681> </span>service<span style=color:#6e7681> </span>being<span style=color:#6e7681> </span>blocked<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>protopayload_auditlog.methodName,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span><span style=color:#ff7b72>method</span><span style=color:#6e7681> </span>name<span style=color:#6e7681> </span>being<span style=color:#6e7681> </span><span style=color:#ff7b72>called</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>resource.labels.project_id<span style=color:#6e7681> </span><span style=color:#ff7b72>as</span><span style=color:#6e7681> </span>PROJECT,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span>protected<span style=color:#6e7681> </span>project<span style=color:#6e7681> </span>blocking<span style=color:#6e7681> </span>the<span style=color:#6e7681> </span><span style=color:#ff7b72>call</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>protopayload_auditlog.authenticationInfo.principalEmail,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span>caller<span style=color:#6e7681> </span><span style=color:#ff7b72>identity</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>protopayload_auditlog.requestMetadata.callerIp,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span>caller<span style=color:#6e7681> </span>IP<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>CASE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>WHEN</span><span style=color:#6e7681> </span>REGEXP_CONTAINS(protopayload_auditlog.requestMetadata.callerIp,<span style=color:#6e7681> </span>r<span style=color:#a5d6ff>&#34;(^127\.)|(^10\.)|(^172\.1[6-9]\.)|(^172\.2[0-9]\.)|(^172\.3[0-1]\.)|(^192\.168\.)&#34;</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>OR</span><span style=color:#6e7681> </span>protopayload_auditlog.requestMetadata.callerIp<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;private&#39;</span><span style=color:#6e7681> </span><span style=color:#ff7b72>THEN</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>ELSE</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>0</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>END</span><span style=color:#6e7681> </span>internal_ip,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span><span style=color:#6e7681> </span>Bool<span style=color:#6e7681> </span><span style=color:#ff7b72>to</span><span style=color:#6e7681> </span>indicate<span style=color:#6e7681> </span>whether<span style=color:#6e7681> </span>the<span style=color:#6e7681> </span>caller<span style=color:#6e7681> </span>IP<span style=color:#6e7681> </span><span style=color:#ff7b72>is</span><span style=color:#6e7681> </span>an<span style=color:#6e7681> </span>RFC1918<span style=color:#6e7681> </span>address<span style=color:#6e7681> </span>range<span style=color:#6e7681> </span><span style=color:#ff7b72>or</span><span style=color:#6e7681> </span><span style=color:#ff7b72>not</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>JSON_EXTRACT(protopayload_auditlog.metadataJson,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;$.dryRun&#39;</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>as</span><span style=color:#6e7681> </span>DRYRUN,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span>dry<span style=color:#ff7b72;font-weight:700>-</span>run<span style=color:#6e7681> </span>indicator<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>JSON_EXTRACT(protopayload_auditlog.metadataJson,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;$.violationReason&#39;</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>as</span><span style=color:#6e7681> </span>REASON,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span>reason<span style=color:#6e7681> </span><span style=color:#ff7b72>for</span><span style=color:#6e7681> </span>violation<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>protopayload_auditlog.metadataJson,<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span>raw<span style=color:#6e7681> </span>violation<span style=color:#6e7681> </span>entry<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72;font-weight:700>`</span><span style=color:#f85149>${</span>project<span style=color:#f85149>}</span>.<span style=color:#f85149>${</span>dataset<span style=color:#f85149>}</span>.cloudaudit_googleapis_com_policy<span style=color:#ff7b72;font-weight:700>`</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> 
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>JSON_EXTRACT(protopayload_auditlog.metadataJson,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;$.dryRun&#39;</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;true&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>#</span>ensure<span style=color:#6e7681> </span>these<span style=color:#6e7681> </span><span style=color:#ff7b72>are</span><span style=color:#6e7681> </span>dry<span style=color:#ff7b72;font-weight:700>-</span>run<span style=color:#6e7681> </span>logs<span style=color:#6e7681>
</span></span></span></code></pre></div><p>The good thing about Google&rsquo;s version is that it uses the <code>as</code> keyword to create aliases for table columns that are more user friendly, so you do not need to rename them in Looker Studio. I have amended it to include the column that indicates if the IP is internal or not from Lorenzo&rsquo;s version.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Vijay Thakorlal
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>