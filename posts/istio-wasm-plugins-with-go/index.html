<!doctype html><html lang=en><head><title>Using Istio WASMPlugin to modify Envoy functionality · Vijay Thakorlal's Blog
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Vijay Thakorlal"><meta name=description content="In a previous post, we went through an example of using Envoy Filters to modify the envoy proxy behaviour in Istio. In this post we will discuss using WASMPlugin.
The WebAssembly for Proxies ABI Specification provides an application binary interface specification for proxies - while originally developed for Envoy it is not envoy specific. There are SDKs for C++, Go, Rust and AssemblyScript itself.
We will be using the Go SDK for Proxy-Wasm, which uses TinyGo - mainly because I don&rsquo;t know Rust and I have not written C++ for a long time &#x1f604;"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Istio WASMPlugin to modify Envoy functionality"><meta name=twitter:description content="In a previous post, we went through an example of using Envoy Filters to modify the envoy proxy behaviour in Istio. In this post we will discuss using WASMPlugin.
The WebAssembly for Proxies ABI Specification provides an application binary interface specification for proxies - while originally developed for Envoy it is not envoy specific. There are SDKs for C++, Go, Rust and AssemblyScript itself.
We will be using the Go SDK for Proxy-Wasm, which uses TinyGo - mainly because I don&rsquo;t know Rust and I have not written C++ for a long time &#x1f604;"><meta property="og:title" content="Using Istio WASMPlugin to modify Envoy functionality"><meta property="og:description" content="In a previous post, we went through an example of using Envoy Filters to modify the envoy proxy behaviour in Istio. In this post we will discuss using WASMPlugin.
The WebAssembly for Proxies ABI Specification provides an application binary interface specification for proxies - while originally developed for Envoy it is not envoy specific. There are SDKs for C++, Go, Rust and AssemblyScript itself.
We will be using the Go SDK for Proxy-Wasm, which uses TinyGo - mainly because I don&rsquo;t know Rust and I have not written C++ for a long time &#x1f604;"><meta property="og:type" content="article"><meta property="og:url" content="https://vijayjt.github.io/posts/istio-wasm-plugins-with-go/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-09T18:23:48+00:00"><meta property="article:modified_time" content="2024-01-09T18:23:48+00:00"><link rel=canonical href=https://vijayjt.github.io/posts/istio-wasm-plugins-with-go/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.e1bdf152d93b060b06ba5d496486ed9c201a8b95d335e035beb5faebe3b61cad.css integrity="sha256-4b3xUtk7BgsGul1JZIbtnCAai5XTNeA1vrX66+O2HK0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Vijay Thakorlal's Blog
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://vijayjt.github.io/posts/istio-wasm-plugins-with-go/>Using Istio WASMPlugin to modify Envoy functionality</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-01-09T18:23:48Z>January 9, 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
8-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/kubernetes/>Kubernetes</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/istio/>Istio</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/envoy/>Envoy</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/lua/>Lua</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/wasm/>WASM</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/golang/>Golang</a></span></div></div></header><div class=post-content><p>In a previous <a href=https://vijayjt.github.io/posts/istio-envoy-filters-lua/>post</a>, we went through an example of using Envoy Filters to modify the envoy proxy behaviour in Istio.
In this post we will discuss using <a href=https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/ class=external-link target=_blank rel=noopener>WASMPlugin</a>.</p><p>The WebAssembly for Proxies ABI <a href=https://github.com/proxy-wasm/spec class=external-link target=_blank rel=noopener>Specification</a> provides an application binary interface specification for proxies - while originally developed for Envoy it is not envoy specific. There are SDKs for C++, Go, Rust and AssemblyScript itself.</p><p>We will be using the <a href="https://github.com/tetratelabs/proxy-wasm-go-sdk?tab=readme-ov-file" class=external-link target=_blank rel=noopener>Go SDK for Proxy-Wasm</a>, which uses <a href=https://tinygo.org/ class=external-link target=_blank rel=noopener>TinyGo</a> - mainly because I don&rsquo;t know Rust and I have not written C++ for a long time &#x1f604;</p><p>One thing to keep in mind is that not all Go <a href=https://tinygo.org/docs/reference/lang-support/ class=external-link target=_blank rel=noopener>language features</a> and standard library packages are <a href=https://tinygo.org/docs/reference/lang-support/stdlib/ class=external-link target=_blank rel=noopener>supported</a> (in some cases the packages can be imported but not all the tests have passed so your mileage my vary if you use the package anyway).</p><p>First install <a href=https://tinygo.org/getting-started/install/linux/ class=external-link target=_blank rel=noopener>TinyGo</a> (I assume that you already have Go installed):</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://github.com/tinygo-org/tinygo/releases/download/v0.30.0/tinygo_0.30.0_amd64.deb
</span></span><span style=display:flex><span>sudo dpkg -i tinygo_0.30.0_amd64.deb
</span></span></code></pre></div><p>Then in your directory that will contain your code run <code>go mod init example-wasm-plugin</code> (or whatever you want to name your package)</p><p>The full example code is available in this <a href=https://github.com/vijayjt/example-istio-wasm-plugin class=external-link target=_blank rel=noopener>repo</a>.</p><p>I used the <a href=https://github.com/tetratelabs/proxy-wasm-go-sdk/tree/main/examples class=external-link target=_blank rel=noopener>examples</a> provider by Tetrate to get started with structuring my code. The <a href=https://github.com/tetratelabs/proxy-wasm-go-sdk/blob/main/doc/OVERVIEW.md class=external-link target=_blank rel=noopener>overview</a> was also useful to understand the interfaces I needed to satisfy in the code and how these map to envoy configuration.</p><h2 id=plugin-configuration>Plugin Configuration
<a class=heading-link href=#plugin-configuration><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Similar to how with the Envoy Filter in Lua we read configuration from metadata, the <a href=https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/ class=external-link target=_blank rel=noopener>WASMPlugin</a> resource allows configuration to be passed via the <code>PluginConfig</code> field.</p><p>To support this we create two structs:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// pluginContext implements types.PluginContext interface of proxy-wasm-go SDK.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>type</span> pluginContext <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// Embed the default plugin context here,
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#8b949e;font-style:italic>// so that we don&#39;t need to reimplement all the methods.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        types.DefaultPluginContext
</span></span><span style=display:flex><span>        configuration pluginConfiguration
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// pluginConfiguration is a type to represent an example configuration for this wasm plugin.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>type</span> pluginConfiguration <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>        targetURLPrefixes []<span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>        startStatusCode   <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>        endStatusCode     <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>        problemTypeURIMap <span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>string</span>]<span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>        problemTitle <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>pluginConfiguration</code> struct represents the configuration items specific to our plugins We then specify this in the <code>pluginContext</code> struct.</p><p>The <code>OnPluginStart</code> function is called when the plugin is first loaded, this is where we will fetch the plugin configuration and parse it in our <code>parsePluginConfiguration</code> function.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Override types.DefaultPluginContext.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> (ctx <span style=color:#ff7b72;font-weight:700>*</span>pluginContext) <span style=color:#d2a8ff;font-weight:700>OnPluginStart</span>(pluginConfigurationSize <span style=color:#ff7b72>int</span>) types.OnPluginStartStatus {
</span></span><span style=display:flex><span>        data, err <span style=color:#ff7b72;font-weight:700>:=</span> proxywasm.<span style=color:#d2a8ff;font-weight:700>GetPluginConfiguration</span>()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> err <span style=color:#ff7b72;font-weight:700>!=</span> types.ErrorStatusNotFound {
</span></span><span style=display:flex><span>                proxywasm.<span style=color:#d2a8ff;font-weight:700>LogCriticalf</span>(<span style=color:#a5d6ff>&#34;error reading plugin configuration: %v&#34;</span>, err)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> types.OnPluginStartStatusFailed
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        config, err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>parsePluginConfiguration</span>(data)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>                proxywasm.<span style=color:#d2a8ff;font-weight:700>LogCriticalf</span>(<span style=color:#a5d6ff>&#34;error parsing plugin configuration: %v&#34;</span>, err)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> types.OnPluginStartStatusFailed
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        ctx.configuration = config
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> types.OnPluginStartStatusOK
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can refer to the code in GitHub for the full details of the <code>parsePluginConfiguration</code> function but it will simply read the configuration and create an instance of the <code>pluginConfiguration</code> struct and return this.</p><h2 id=modify-filter-chains>Modify Filter Chains
<a class=heading-link href=#modify-filter-chains><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The API provides different functions which you must implement to modify request/response headers or body (see <a href=https://github.com/tetratelabs/proxy-wasm-go-sdk/blob/b089ccb942195f3ac34dca36b629be91b9c962ff/proxywasm/types/context.go#L210 class=external-link target=_blank rel=noopener>here</a>).</p><p>We will only look at two here. <code>OnHttpRequestheaders</code> is called when request headers arrive. An example is shown below of how to fetch headers.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (ctx <span style=color:#ff7b72;font-weight:700>*</span>customErrorsContext) <span style=color:#d2a8ff;font-weight:700>OnHttpRequestHeaders</span>(numHeaders <span style=color:#ff7b72>int</span>, endOfStream <span style=color:#ff7b72>bool</span>) types.Action {
</span></span><span style=display:flex><span>   &lt;<span style=color:#ff7b72;font-weight:700>...</span> removed <span style=color:#ff7b72>for</span> brevity <span style=color:#ff7b72;font-weight:700>...</span>&gt;
</span></span><span style=display:flex><span>   scheme, err <span style=color:#ff7b72;font-weight:700>:=</span> proxywasm.<span style=color:#d2a8ff;font-weight:700>GetHttpRequestHeader</span>(<span style=color:#a5d6ff>&#34;:scheme&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>           proxywasm.<span style=color:#d2a8ff;font-weight:700>LogErrorf</span>(<span style=color:#a5d6ff>&#34;failed to get request header scheme. Error: %v&#34;</span>, err)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   &lt;<span style=color:#ff7b72;font-weight:700>...</span> removed <span style=color:#ff7b72>for</span> brevity <span style=color:#ff7b72;font-weight:700>...</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>return</span> types.ActionContinue
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>There are only two Action types, which mean exactly what you would think, ActionContinue means that the host continues the processing and ActionPause will pause processing.</p><p>If you are not familiar with http2 then you may be wondering about these headers with &ldquo;:&rdquo; in the name, these are new <a href=https://datatracker.ietf.org/doc/html/rfc9113#name-request-pseudo-header-field class=external-link target=_blank rel=noopener>psuedo-headers</a> added for http2, they have a colon in the name so that older clients that do not understand http2 will ignore those headers</p><p>A snippet from the <code>OnHttpResponseBody</code> function is shown below:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (ctx <span style=color:#ff7b72;font-weight:700>*</span>customErrorsContext) <span style=color:#d2a8ff;font-weight:700>OnHttpResponseBody</span>(bodySize <span style=color:#ff7b72>int</span>, endOfStream <span style=color:#ff7b72>bool</span>) types.Action {
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>if</span> !ctx.modifyResponse {
</span></span><span style=display:flex><span>           <span style=color:#ff7b72>return</span> types.ActionContinue
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   proxywasm.<span style=color:#d2a8ff;font-weight:700>LogInfof</span>(<span style=color:#a5d6ff>&#34;BEGIN OnHttpResponseBody&#34;</span>)
</span></span><span style=display:flex><span>   ctx.totalResponseBodySize <span style=color:#ff7b72;font-weight:700>+=</span> bodySize
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>if</span> !endOfStream {
</span></span><span style=display:flex><span>           <span style=color:#8b949e;font-style:italic>// Wait until we see the entire body before modifying it.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>           <span style=color:#ff7b72>return</span> types.ActionPause
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   originalBody, err <span style=color:#ff7b72;font-weight:700>:=</span> proxywasm.<span style=color:#d2a8ff;font-weight:700>GetHttpResponseBody</span>(<span style=color:#a5d6ff>0</span>, ctx.totalResponseBodySize)
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>           proxywasm.<span style=color:#d2a8ff;font-weight:700>LogErrorf</span>(<span style=color:#a5d6ff>&#34;failed to get response body. Error: %v&#34;</span>, err)
</span></span><span style=display:flex><span>           <span style=color:#ff7b72>return</span> types.ActionContinue
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   &lt;<span style=color:#ff7b72;font-weight:700>...</span> removed <span style=color:#ff7b72>for</span> brevity <span style=color:#ff7b72;font-weight:700>...</span>&gt;
</span></span></code></pre></div><p>The OnHttpResponseBody function will get called multiple times as the response body is processed, when the full response body is received <code>endOfStream</code> will be <code>true</code>.
Since we intend to read and modify the response body, we also keep track of the response body size so we can use int in the call to <code>GetHttpResponseBody</code>.</p><h2 id=building-the-code>Building the code
<a class=heading-link href=#building-the-code><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We can build a wasm binary from our code using tinygo ass follows:</p><p><code>tinygo build -o ./custom-errors.wasm -scheduler=none -target=wasi ./main.go</code></p><h2 id=tests>Tests
<a class=heading-link href=#tests><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The TetrateLabs repo for the Go SDK provides some very good example plugins that include tests so I won&rsquo;t go into a lot of detail about <code>main_test.go</code> in our code, but I will call out a few things.</p><p>A snippet of one of the test functions is provided below:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>TestOnHttpResponseHeaders</span>(t <span style=color:#ff7b72;font-weight:700>*</span>testing.T) {
</span></span><span style=display:flex><span>   <span style=color:#d2a8ff;font-weight:700>vmTest</span>(t, <span style=color:#ff7b72>func</span>(t <span style=color:#ff7b72;font-weight:700>*</span>testing.T, vm types.VMContext) {
</span></span><span style=display:flex><span>   opt <span style=color:#ff7b72;font-weight:700>:=</span> proxytest.<span style=color:#d2a8ff;font-weight:700>NewEmulatorOption</span>().
</span></span><span style=display:flex><span>           <span style=color:#d2a8ff;font-weight:700>WithPluginConfiguration</span>([]byte(<span style=color:#a5d6ff>`{&#34;targetURLPrefixes&#34;: [&#34;my-host.com&#34;]}`</span>)).
</span></span><span style=display:flex><span>           <span style=color:#d2a8ff;font-weight:700>WithVMContext</span>(vm)
</span></span><span style=display:flex><span>   host, reset <span style=color:#ff7b72;font-weight:700>:=</span> proxytest.<span style=color:#d2a8ff;font-weight:700>NewHostEmulator</span>(opt)
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>defer</span> <span style=color:#d2a8ff;font-weight:700>reset</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   require.<span style=color:#d2a8ff;font-weight:700>Equal</span>(t, types.OnPluginStartStatusOK, host.<span style=color:#d2a8ff;font-weight:700>StartPlugin</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   t.<span style=color:#d2a8ff;font-weight:700>Run</span>(<span style=color:#a5d6ff>&#34;http status code is preserved&#34;</span>, <span style=color:#ff7b72>func</span>(t <span style=color:#ff7b72;font-weight:700>*</span>testing.T) {
</span></span><span style=display:flex><span>           <span style=color:#8b949e;font-style:italic>// Initialize http context.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>           id <span style=color:#ff7b72;font-weight:700>:=</span> host.<span style=color:#d2a8ff;font-weight:700>InitializeHttpContext</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>           <span style=color:#8b949e;font-style:italic>// Call OnHttpRequestHeaders with the headers set to simulate a real request
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>           hs <span style=color:#ff7b72;font-weight:700>:=</span> [][<span style=color:#a5d6ff>2</span>]<span style=color:#ff7b72>string</span>{{<span style=color:#a5d6ff>&#34;:authority&#34;</span>, <span style=color:#a5d6ff>&#34;my-host.com&#34;</span>}, {<span style=color:#a5d6ff>&#34;:scheme&#34;</span>, <span style=color:#a5d6ff>&#34;https&#34;</span>}, {<span style=color:#a5d6ff>&#34;:path&#34;</span>, <span style=color:#a5d6ff>&#34;/&#34;</span>}}
</span></span><span style=display:flex><span>           action <span style=color:#ff7b72;font-weight:700>:=</span> host.<span style=color:#d2a8ff;font-weight:700>CallOnRequestHeaders</span>(id, hs, <span style=color:#79c0ff>false</span>)
</span></span></code></pre></div><ul><li>Note that the SDK provides an emulator that can be used for our unit tests</li><li>We can provide configuration via <code>WithPluginConfiguration</code></li><li>In our case we will use go test to run our tests instead of using tiny go&mldr;mainly because that allows us to use the testify package</li></ul><p>At the bottom of the <code>main_test.go</code> file we have this snippet of code:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// vmTest executes f twice, once with a types.VMContext that executes plugin code directly
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// in the host, and again by executing the plugin code within the compiled main.wasm binary.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Execution with main.wasm will be skipped if the file cannot be found.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>vmTest</span>(t <span style=color:#ff7b72;font-weight:700>*</span>testing.T, f <span style=color:#ff7b72>func</span>(<span style=color:#ff7b72;font-weight:700>*</span>testing.T, types.VMContext)) {
</span></span><span style=display:flex><span>        t.<span style=color:#d2a8ff;font-weight:700>Helper</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        t.<span style=color:#d2a8ff;font-weight:700>Run</span>(<span style=color:#a5d6ff>&#34;go&#34;</span>, <span style=color:#ff7b72>func</span>(t <span style=color:#ff7b72;font-weight:700>*</span>testing.T) {
</span></span><span style=display:flex><span>                <span style=color:#d2a8ff;font-weight:700>f</span>(t, <span style=color:#ff7b72;font-weight:700>&amp;</span>vmContext{})
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        t.<span style=color:#d2a8ff;font-weight:700>Run</span>(<span style=color:#a5d6ff>&#34;wasm&#34;</span>, <span style=color:#ff7b72>func</span>(t <span style=color:#ff7b72;font-weight:700>*</span>testing.T) {
</span></span><span style=display:flex><span>                wasm, err <span style=color:#ff7b72;font-weight:700>:=</span> os.<span style=color:#d2a8ff;font-weight:700>ReadFile</span>(<span style=color:#a5d6ff>&#34;custom-errors.wasm&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>                        t.<span style=color:#d2a8ff;font-weight:700>Skip</span>(<span style=color:#a5d6ff>&#34;wasm not found&#34;</span>)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                v, err <span style=color:#ff7b72;font-weight:700>:=</span> proxytest.<span style=color:#d2a8ff;font-weight:700>NewWasmVMContext</span>(wasm)
</span></span><span style=display:flex><span>                require.<span style=color:#d2a8ff;font-weight:700>NoError</span>(t, err)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>defer</span> v.<span style=color:#d2a8ff;font-weight:700>Close</span>()
</span></span><span style=display:flex><span>                <span style=color:#d2a8ff;font-weight:700>f</span>(t, v)
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can see that the tests will be called twice one where the code is executed directly and a second time with the compiled binary. So each time you modify the code don&rsquo;t forget to build the binary before running the tests with <code>go test ./... -v</code>.</p><h2 id=deploying-our-plugin>Deploying our plugin
<a class=heading-link href=#deploying-our-plugin><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Next lets create our WASMPlugin kubernetes/Istio resource:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>extensions.istio.io/v1alpha1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>WasmPlugin</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>custom-errors</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>istio-system</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>selector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>matchLabels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>istio-ingressgateway</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>url</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>oci://myregistry.azurecr.io/istio-custom-errors:v0.0.1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>imagePullPolicy</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Always</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>imagePullSecret</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>acr-oci-pull-secret</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>phase</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>AUTHN</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>failStrategy</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>FAIL_OPEN</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>pluginConfig</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>problemTypeURIMap</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>400</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.1&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>401</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.2&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>403</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.4&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>404</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.5&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>405</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.6&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>406</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.7&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>408</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.9&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>409</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.10&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>412</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.13&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>415</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.16&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>422</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc4918#section-11.2&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>426</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.22&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>500</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.6.1&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>502</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.6.3&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>503</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.6.4&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>504</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.6.5&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>endStatusCode</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>400</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>startStatusCode</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>599</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>targetURLPrefixes</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#a5d6ff>foo.bar.com</span><span style=color:#6e7681>
</span></span></span></code></pre></div><ul><li>This plugin will only be expected for requests received through an Istio Gateway with the label <code>app: istio-ingressgateway</code></li><li>In this case we will package up our binary as an OCI container image. For this to work we must provide a pull secret that can be used to pull images from the registry. This is required even if you have other workloads in the cluster that are able to pull images directly from your cloud provider registry.</li><li>The <code>phase</code> field controls where the plugin will be injected</li><li>The <code>failStrategy</code> when set to <code>FAIL_CLOSE</code> will mean if the WASM binary cannot be accessed or there is an error during its execution the request will be denied. Whereas <code>FAIL_OPEN</code> will allow the request to proceed. The documentation advises that plugins that perform some form of Authentication or Authorization should fail close. However, in our case since all we are doing is modifying error responses it is okay and indeed better to fail open. It is important that you have sufficient unit, integration and other types of tests for your plugins to ensure that the plugin will not impact performance or cause an outage.</li></ul><p>We are going to use an OCI image to deploy our plugin as this is relatively simple option. However, there are other options:</p><ul><li><code>url</code> can be a <code>http[s]://</code> URL - this does mean that this URL must be accessible to Istio without authentication.</li><li><code>url</code> can also refer to a file via <code>file://</code> that is local to the proxy container. You could for example do this by storing the binary in a ConfigMap and then mounting this in proxies using the <code>sidecar.istio.io/userVolume</code> and <code>sidecar.istio.io/userVolumeMount</code> annotations. But to be honest this is not really practical for production.</li></ul><p>Our container image can be created from the scratch image:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#ff7b72>FROM</span><span style=color:#a5d6ff> scratch</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>COPY</span> custom-errors.wasm ./plugin.wasm<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>ENTRYPOINT</span> [ <span style=color:#a5d6ff>&#34;plugin.wasm&#34;</span> ]<span style=color:#f85149>
</span></span></span></code></pre></div><p>Azure Container Registry (ACR) supports OCI images so in our example we are publishing the image to ACR.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#79c0ff>VERSION</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;v0.0.1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>ACR_REPO</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;myregistry&#34;</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>ACR_DOMAIN</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>ACR_REPO</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.azurecr.io&#34;</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>DOCKER_IMAGE</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>ACR_DOMAIN</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/istio-custom-errors:</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>VERSION</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build . -t <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>DOCKER_IMAGE</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>az acr login -n <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>ACR_REPO</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker push <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>DOCKER_IMAGE</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span></code></pre></div><p>But we do need to create a pull secret - here we are using an EntraID Service Principal (an alternative would be to use a <a href=https://learn.microsoft.com/en-us/azure/container-registry/container-registry-repository-scoped-permissions class=external-link target=_blank rel=noopener>repository scoped access token</a>).</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#79c0ff>ARM_CLIENT_ID</span><span style=color:#ff7b72;font-weight:700>=</span>xxxx-xxxx-xxxx-xxxxxxx-xxxx
</span></span><span style=display:flex><span><span style=color:#79c0ff>ARM_CLIENT_SECRET</span><span style=color:#ff7b72;font-weight:700>=</span>somesecret
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create secret docker-registry acr-oci-pull-secret <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    --namespace istio-system <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    --docker-server<span style=color:#ff7b72;font-weight:700>=</span>myregistry.azurecr.io <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    --docker-username<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>ARM_CLIENT_ID</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    --docker-password<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>ARM_CLIENT_SECRET</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span></code></pre></div><p>Note that to display info level logs you would need to change the default logging configuration. This can be achieved with the istioctl command line tool:</p><p><code>istioctl proxy-config log istio-ingressgateway-5576bb6d65-qzj9j --level wasm:info</code></p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Vijay Thakorlal
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>