<!doctype html><html lang=en><head><title>Istio Envoy Filters with Lua · Vijay Thakorlal's Blog
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Vijay Thakorlal"><meta name=description content="Istio Envoy Filters provides a way customise Envoy&rsquo;s behaviour. They can be useful when you have a requirement that cannot be fulfilled out of the box by Istio.
Warning
When using Envoy Filters we are using low-level APIs that can change between Istio versions. It is therefore important that you have robust tests in place and review change logs/release notes carefully for changes that may break your filters.
Envoy itself has a number of built-in filters but we are specifically going to talk about Lua filters which allows Lua code to be executed during both the request and response flows."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Istio Envoy Filters with Lua"><meta name=twitter:description content="Istio Envoy Filters provides a way customise Envoy&rsquo;s behaviour. They can be useful when you have a requirement that cannot be fulfilled out of the box by Istio.
Warning
When using Envoy Filters we are using low-level APIs that can change between Istio versions. It is therefore important that you have robust tests in place and review change logs/release notes carefully for changes that may break your filters.
Envoy itself has a number of built-in filters but we are specifically going to talk about Lua filters which allows Lua code to be executed during both the request and response flows."><meta property="og:title" content="Istio Envoy Filters with Lua"><meta property="og:description" content="Istio Envoy Filters provides a way customise Envoy&rsquo;s behaviour. They can be useful when you have a requirement that cannot be fulfilled out of the box by Istio.
Warning
When using Envoy Filters we are using low-level APIs that can change between Istio versions. It is therefore important that you have robust tests in place and review change logs/release notes carefully for changes that may break your filters.
Envoy itself has a number of built-in filters but we are specifically going to talk about Lua filters which allows Lua code to be executed during both the request and response flows."><meta property="og:type" content="article"><meta property="og:url" content="https://vijayjt.github.io/posts/istio-envoy-filters-lua/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-09T11:05:23+00:00"><meta property="article:modified_time" content="2024-01-09T11:05:23+00:00"><link rel=canonical href=https://vijayjt.github.io/posts/istio-envoy-filters-lua/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.e1bdf152d93b060b06ba5d496486ed9c201a8b95d335e035beb5faebe3b61cad.css integrity="sha256-4b3xUtk7BgsGul1JZIbtnCAai5XTNeA1vrX66+O2HK0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Vijay Thakorlal's Blog
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://vijayjt.github.io/posts/istio-envoy-filters-lua/>Istio Envoy Filters with Lua</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-01-09T11:05:23Z>January 9, 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
8-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/kubernetes/>Kubernetes</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/istio/>Istio</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/envoy/>Envoy</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/lua/>Lua</a></span></div></div></header><div class=post-content><p>Istio <a href=https://istio.io/latest/docs/reference/config/networking/envoy-filter/ class=external-link target=_blank rel=noopener>Envoy Filters</a> provides a way customise Envoy&rsquo;s behaviour. They can be useful when you have a requirement that cannot be fulfilled out of the box by Istio.</p><blockquote><p><strong>Warning</strong></p><p>When using Envoy Filters we are using low-level APIs that can change between Istio versions. It is therefore important that you have robust tests in place
and review change logs/release notes carefully for changes that may break your filters.</p></blockquote><p>Envoy itself has a number of <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/http_filters class=external-link target=_blank rel=noopener>built-in</a> filters but we are specifically going to talk about <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/lua_filter class=external-link target=_blank rel=noopener>Lua</a> filters which allows Lua code to be executed during both the request and response flows.</p><p>It is worth noting that Lua filters have some drawbacks:</p><ul><li>You&rsquo;re effectively embedding Lua code inside YAML which is not a great developer experience. Even syntax errors may not be caught until you try to deploy the filter.</li><li>It&rsquo;s hard to test the Lua code embedded in the YAML.</li></ul><p>You could use the <code>sidecar.istio.io/userVolume</code> and <code>sidecar.istio.io/userVolumeMount</code> <a href=https://istio.io/latest/docs/reference/config/annotations/ class=external-link target=_blank rel=noopener>annotations</a> to mount Lua code that is in a ConfigMap as a volume in the istio-proxy containers. This could for example allow you to attempt to modularise the code and create libraries etc. but this is a pain to maintain.</p><p>An alternative is to use <a href=https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/ class=external-link target=_blank rel=noopener>WasmPlugins</a> and write your code in Go, Rust or other supported languages. We will discuss this option in another post.</p><h2 id=full-example>Full example
<a class=heading-link href=#full-example><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The full example is shown below - this filter is used to modify the format of error responses (e.g. HTTP Status code 400 and above), we will discuss the various elements of this filter.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.istio.io/v1alpha3</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>EnvoyFilter</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>my-custom-filter</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>istio-system</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># Namespace where istio gateway pods are actually running</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>workloadSelector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>istio-ingressgateway</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>configPatches</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># Patch that creates &#34;global&#34; lua filter that does nothing useful</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>applyTo</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HTTP_FILTER</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>match</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>listener</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>filterChain</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>filter</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>envoy.filters.network.http_connection_manager</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>subFilter</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>envoy.filters.http.router</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>patch</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>operation</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>INSERT_BEFORE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>envoy.lua</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>typed_config</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>&#39;@type&#39;</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>inlineCode</span>:<span style=color:#6e7681> </span>|<span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            function envoy_on_request(request_handle)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>              -- Empty lua function
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            end</span><span style=color:#6e7681>            
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># Filter for http route that overrides &#34;global&#34; filter lua source code</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>applyTo</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HTTP_ROUTE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>match</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>context</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>GATEWAY</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>routeConfiguration</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>vhost</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>route</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;foo-virtual-service.bar-namespace.svc.cluster.local:443&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>patch</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>operation</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>MERGE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>filter_metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>envoy.filters.http.lua</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>default_trace_id</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;00-0aa0000000aa00aa0000aa000a00000a-a0aa0a0000000000-00&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>default_problem_title</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;Istio API Ingress gateway returned an error&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>default4xx_problem_type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://datatracker.ietf.org/doc/html/rfc9110#name-client-error-4xx&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>default5xx_problem_type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://datatracker.ietf.org/doc/html/rfc9110#name-client-error-5xx&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>problem_type_uri_map</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>400</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.1&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>401</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.2&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>403</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.4&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>404</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.5&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>405</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.6&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>406</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.7&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>408</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.9&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>409</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.10&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>412</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.13&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>415</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.16&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>422</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc4918#section-11.2&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>426</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.22&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>500</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.6.1&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>502</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.6.3&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>503</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.6.4&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>504</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.6.5&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>envoy.filters.http.lua</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>typed_per_filter_config</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>envoy.filters.http.lua</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>&#39;@type&#39;</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>source_code</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>inline_string</span>:<span style=color:#6e7681> </span>|<span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                -- Extract request info and set as dynamic metadata so we can use it in the response
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                function envoy_on_request(request_handle)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  headers = request_handle:headers()
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  request_path = headers:get(&#34;:path&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  for key, value in pairs (headers) do
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                      if key == nil or value == nil then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                      request_handle:logInfo(&#34;[CUSTOM FILTER] NIL&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                      else
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                      request_handle:logInfo(&#34;[CUSTOM FILTER] Header:&#34; .. key .. &#34; -&gt; &#34; .. value)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                      end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  -- If the W3C traceparent header is not present use the istio x-request-id instead
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  -- are there any cases where even this may be nil?
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  trace_id = headers:get(&#34;traceparent&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  if trace_id == nil then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    trace_id = headers:get(&#34;x-request-id&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  if trace_id == nil then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    local metadata = response_handle:metadata()
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    trace_id = metadata:get(&#34;default_trace_id&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  request_handle:streamInfo():dynamicMetadata():set(&#34;context&#34;, &#34;xx.request.traceid&#34;, trace_id)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  request_handle:streamInfo():dynamicMetadata():set(&#34;context&#34;, &#34;xx.request.path&#34;, request_path)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                -- Returns the problem type URI for a given HTTP status code 
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                function get_problem_type_uri(status_code, response_handle)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  -- get filter metadata - which is different to dynamic metadata
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  local metadata = response_handle:metadata()
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  problem_type_uri_map = metadata:get(&#34;problem_type_uri_map&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  default4xx_problem_type = metadata:get(&#34;default4xx_problem_type&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  default5xx_problem_type = metadata:get(&#34;default5xx_problem_type&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  problem_type_uri = &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  for id, uri_lookup in pairs(problem_type_uri_map) do
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    for code, uri in pairs(uri_lookup) do
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                      if code == status_code then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                        problem_type_uri = uri
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                      end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  if problem_type_uri == &#34;&#34; and status_code:match(&#39;^4(.*)&#39;)  then 
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    problem_type_uri = default4xx_problem_type
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  elseif problem_type_uri == &#34;&#34; and status_code:match(&#39;^5(.*)&#39;)  then 
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    problem_type_uri = default5xx_problem_type
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  return problem_type_uri
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                -- Customise the response
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                function envoy_on_response(response_handle)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  headers = response_handle:headers()
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  original_content_type = headers:get(&#34;content-type&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  response_content_type = &#34;application/problem+json&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  response_handle:logInfo(string.format(&#34;ORIGINAL CONTENT TYPE: %s&#34;, original_content_type))
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  resp_status_str = headers:get(&#34;:status&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  resp_status_int = tonumber(resp_status_str)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  request_path = response_handle:streamInfo():dynamicMetadata():get(&#34;context&#34;)[&#34;xx.request.path&#34;]
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  trace_id = response_handle:streamInfo():dynamicMetadata():get(&#34;context&#34;)[&#34;xx.request.traceid&#34;]
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  problem_type_uri = get_problem_type_uri(resp_status_str, response_handle)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  -- note we can&#39;t use this for 404 errors apparently so a separate filter is required for that
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  if resp_status_int &gt;= 400 and resp_status_int &lt;= 599 and original_content_type ~= &#34;text/html&#34; then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   response_handle:logInfo(string.format(&#34;http status code is %s, customising error response&#34;, resp_status_str))
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   response_handle:headers():replace(&#34;content-type&#34;, response_content_type)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   local body_str = &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   local body = response_handle:body()
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   if body == nil then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                     body_str = &#34;Service mesh returned http &#34; .. resp_status_str .. &#34; status code.&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   else
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                     body_str = tostring(body:getBytes(0, body:length()))
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   -- The double brackets are a string concatenation / heredocs like operator
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   -- We un-indent to avoid extraneous leading spaces in the response JSON
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   local resp=[[
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  &#34;type&#34;: &#34;]] .. problem_type_uri .. [[&#34;,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  &#34;title&#34;: &#34;service mesh returned an HTTP ]] .. resp_status_str .. [[ error.&#34;,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  &#34;status&#34;: ]] .. resp_status_str .. [[,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  &#34;instance&#34;: &#34;]] .. request_path .. [[&#34;,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  &#34;trace_id&#34;: &#34;]] .. trace_id .. [[&#34;,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  &#34;detail&#34;: &#34;]] .. body_str .. [[&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                ]]
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   -- Pass in always_wrap_body to ensure Istio/Envoy always returns a body object even if the body is empty.
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   -- Certain types of errors returned by Istio will have an empty body and without always_wrap_body this would result an exception being thrown in our code.
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   always_wrap_body = true
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                   response_handle:body(always_wrap_body):setBytes(resp)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  -- end if http status
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                end</span><span style=color:#6e7681>                
</span></span></span></code></pre></div><h2 id=scoping-the-filter>Scoping the filter
<a class=heading-link href=#scoping-the-filter><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In this case we create the filter in the istio-system namespace and it specifically applies to an ingress <a href=https://istio.io/latest/docs/reference/config/networking/gateway/ class=external-link target=_blank rel=noopener>Gateway</a> with the label <code>istio-ingressgateway</code> this allows you to target the filter to specific gateways.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.istio.io/v1alpha3</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>EnvoyFilter</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>my-custom-filter</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>istio-system</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># Namespace where istio gateway pods are actually running</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>workloadSelector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>istio-ingressgateway</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>In this case we have a requirement to only apply the filter for specific routes so:</p><ul><li>We have an empty filter that does nothing</li><li>Then create another filter that is scoped to a specific virtual host <code>foo-virtual-service.bar-namespace.svc.cluster.local</code> this should match the cluster local FQDN for your virtual service.</li></ul><p>An alternative would be to just check the request URL and if it does not match the one we are interested in do nothing (you can derive the request URL from the <code>authority</code> and <code>path</code> headers.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>configPatches</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># Patch that creates &#34;global&#34; lua filter that does nothing useful</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>applyTo</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HTTP_FILTER</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>match</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>listener</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>filterChain</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>filter</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>envoy.filters.network.http_connection_manager</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>subFilter</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>envoy.filters.http.router</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>patch</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>operation</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>INSERT_BEFORE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>envoy.lua</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>typed_config</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>&#39;@type&#39;</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>inlineCode</span>:<span style=color:#6e7681> </span>|<span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            function envoy_on_request(request_handle)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>              -- Empty lua function
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            end</span><span style=color:#6e7681>            
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># Filter for http route that overrides &#34;global&#34; filter lua source code</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>applyTo</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HTTP_ROUTE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>match</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>context</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>GATEWAY</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>routeConfiguration</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>vhost</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>route</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;foo-virtual-service.bar-namespace.svc.cluster.local:443&#34;</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h2 id=logging-and-comments>Logging and comments
<a class=heading-link href=#logging-and-comments><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We can add logging using <code>handle_name:logInfo</code> to write a info level log message. There are different log levels such as warning, error, info etc.</p><pre tabindex=0><code>    -- Example for string formatting
    response_handle:logInfo(string.format(&#34;http status code is %s, customising error response&#34;, resp_status_str))
    response_handle:logWarn(&#34;This is a warning message&#34;)
    response_handle:logError(&#34;This is an error message&#34;)
    response_handle:logCritical(&#34;This is a critical message&#34;)
</code></pre><p>Comments are prefixed with <code>--</code> double dashes.</p><p>Note that to display info level logs you would need to change the default logging configuration. This can be achieved with the istioctl command line tool:</p><p><code>istioctl proxy-config log istio-ingressgateway-5576bb6d65-qzj9j --level lua:info</code></p><p>Obviously this is a one-off command and if the container are recreated or the deployment is scaled the logging level will not apply. There is an (at least at the time of writing) alpha feature that allows us to set the component logging level using the annotation <code>sidecar.istio.io/componentLogLevel</code>. Refer to the Istio <a href=https://istio.io/latest/docs/reference/config/annotations/ class=external-link target=_blank rel=noopener>documentation</a> for further details. The only problem is you need to specify this annotation in the pod template for the ingress gateway containers in the deployment.</p><h2 id=filter-metadata>Filter metadata
<a class=heading-link href=#filter-metadata><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Filter metadata allows you to define configuration outside of the Lua code that can then be used to modify the behaviour of the Lua code. You may want to do this if you wish to make the code configurable without having to modify the code.</p><p>In the example below <code>default_trace_id</code> is a metadata item that is a string and <code>problem_type_uri_map</code> is a map.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>filter_metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>envoy.filters.http.lua</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>default_trace_id</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;00-0aa0000000aa00aa0000aa000a00000a-a0aa0a0000000000-00&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>problem_type_uri_map</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>400</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.1&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>401</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.2&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#7ee787>403</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;https://tools.ietf.org/html/rfc9110#section-15.5.4&#34;</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>We can then access these metadata items from our code like so:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>    <span style=color:#ff7b72>local</span> metadata <span style=color:#ff7b72;font-weight:700>=</span> response_handle:metadata()
</span></span><span style=display:flex><span>    problem_type_uri_map <span style=color:#ff7b72;font-weight:700>=</span> metadata:get(<span style=color:#a5d6ff>&#34;problem_type_uri_map&#34;</span>)
</span></span><span style=display:flex><span>    default4xx_problem_type <span style=color:#ff7b72;font-weight:700>=</span> metadata:get(<span style=color:#a5d6ff>&#34;default4xx_problem_type&#34;</span>)
</span></span><span style=display:flex><span>    default5xx_problem_type <span style=color:#ff7b72;font-weight:700>=</span> metadata:get(<span style=color:#a5d6ff>&#34;default5xx_problem_type&#34;</span>)
</span></span><span style=display:flex><span>    problem_type_uri <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> id, uri_lookup <span style=color:#ff7b72>in</span> pairs(problem_type_uri_map) <span style=color:#ff7b72>do</span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>for</span> code, uri <span style=color:#ff7b72>in</span> pairs(uri_lookup) <span style=color:#ff7b72>do</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> code <span style=color:#ff7b72;font-weight:700>==</span> status_code <span style=color:#ff7b72>then</span>
</span></span><span style=display:flex><span>          problem_type_uri <span style=color:#ff7b72;font-weight:700>=</span> uri
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>end</span>
</span></span></code></pre></div><p>Notice that for maps we can loop through them using a <a href=https://opensource.com/article/22/11/iterate-over-tables-lua class=external-link target=_blank rel=noopener>for loop</a> and the pairs standard library function.</p><h2 id=dynamic-metadata>Dynamic metadata
<a class=heading-link href=#dynamic-metadata><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/advanced/well_known_dynamic_metadata class=external-link target=_blank rel=noopener>Dynamic metadata</a> allows you to insert custom metadata into the request/response chain that your code can then utilise.</p><p>We can set dynamic metadata like so:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>    request_handle:streamInfo():dynamicMetadata():set(<span style=color:#a5d6ff>&#34;context&#34;</span>, <span style=color:#a5d6ff>&#34;xx.request.traceid&#34;</span>, trace_id)
</span></span><span style=display:flex><span>    request_handle:streamInfo():dynamicMetadata():set(<span style=color:#a5d6ff>&#34;context&#34;</span>, <span style=color:#a5d6ff>&#34;xx.request.path&#34;</span>, request_path)
</span></span></code></pre></div><p>We can then retrieve those values like so:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>    request_path <span style=color:#ff7b72;font-weight:700>=</span> response_handle:streamInfo():dynamicMetadata():get(<span style=color:#a5d6ff>&#34;context&#34;</span>)[<span style=color:#a5d6ff>&#34;xx.request.path&#34;</span>]
</span></span><span style=display:flex><span>    trace_id <span style=color:#ff7b72;font-weight:700>=</span> response_handle:streamInfo():dynamicMetadata():get(<span style=color:#a5d6ff>&#34;context&#34;</span>)[<span style=color:#a5d6ff>&#34;xx.request.traceid&#34;</span>]
</span></span></code></pre></div><h2 id=calling-external-services>Calling external services
<a class=heading-link href=#calling-external-services><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Your Lua filter can also call external services (they could reside outside of your Kubernetes cluster running your filter or be in another namespace in the cluster).</p><p>Here is an example taken directly from the Envoy <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/lua_filter#script-examples class=external-link target=_blank rel=noopener>documentation</a>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#ff7b72>function</span> <span style=color:#d2a8ff;font-weight:700>envoy_on_request</span>(request_handle)
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>-- Make an HTTP call to an upstream host with the following headers, body, and timeout.</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>local</span> headers, body <span style=color:#ff7b72;font-weight:700>=</span> request_handle:httpCall(
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;lua_cluster&#34;</span>,
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    [<span style=color:#a5d6ff>&#34;:method&#34;</span>] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;POST&#34;</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a5d6ff>&#34;:path&#34;</span>] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;/&#34;</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a5d6ff>&#34;:authority&#34;</span>] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;lua_cluster&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;hello world&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>5000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>-- Add information from the HTTP call into the headers that are about to be sent to the next</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>-- filter in the filter chain.</span>
</span></span><span style=display:flex><span>  request_handle:headers():add(<span style=color:#a5d6ff>&#34;upstream_foo&#34;</span>, headers[<span style=color:#a5d6ff>&#34;foo&#34;</span>])
</span></span><span style=display:flex><span>  request_handle:headers():add(<span style=color:#a5d6ff>&#34;upstream_body_size&#34;</span>, <span style=color:#ff7b72;font-weight:700>#</span>body)
</span></span><span style=display:flex><span><span style=color:#ff7b72>end</span>
</span></span></code></pre></div><p>A real world use case may be that you need to implement some custom authentication or authorization that requires calling an external service.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Vijay Thakorlal
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>