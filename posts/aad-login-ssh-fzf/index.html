<!doctype html><html lang=en><head><title>Using fzf with Azure AAD Login to SSH interactively to Azure VMs with fzf · Vijay Thakorlal's Blog
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Vijay Thakorlal"><meta name=description content="AAD Login or EntraID login now, is a feature that allows you to login to Azure VMs using your Entra ID account.
It requires that you have the Virtual Machine Login or Virtual Machine Administrator Login roles (the former logs you in as a regular user and the latter an administrator).
fzf is a command-line fuzzy finder, as the project site states it is an interactive UNIX filter for command-line that can be used with any list, files, etc."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using fzf with Azure AAD Login to SSH interactively to Azure VMs with fzf"><meta name=twitter:description content="AAD Login or EntraID login now, is a feature that allows you to login to Azure VMs using your Entra ID account.
It requires that you have the Virtual Machine Login or Virtual Machine Administrator Login roles (the former logs you in as a regular user and the latter an administrator).
fzf is a command-line fuzzy finder, as the project site states it is an interactive UNIX filter for command-line that can be used with any list, files, etc."><meta property="og:title" content="Using fzf with Azure AAD Login to SSH interactively to Azure VMs with fzf"><meta property="og:description" content="AAD Login or EntraID login now, is a feature that allows you to login to Azure VMs using your Entra ID account.
It requires that you have the Virtual Machine Login or Virtual Machine Administrator Login roles (the former logs you in as a regular user and the latter an administrator).
fzf is a command-line fuzzy finder, as the project site states it is an interactive UNIX filter for command-line that can be used with any list, files, etc."><meta property="og:type" content="article"><meta property="og:url" content="https://vijayjt.github.io/posts/aad-login-ssh-fzf/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-05T19:05:53+00:00"><meta property="article:modified_time" content="2024-01-05T19:05:53+00:00"><link rel=canonical href=https://vijayjt.github.io/posts/aad-login-ssh-fzf/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.e1bdf152d93b060b06ba5d496486ed9c201a8b95d335e035beb5faebe3b61cad.css integrity="sha256-4b3xUtk7BgsGul1JZIbtnCAai5XTNeA1vrX66+O2HK0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Vijay Thakorlal's Blog
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://vijayjt.github.io/posts/aad-login-ssh-fzf/>Using fzf with Azure AAD Login to SSH interactively to Azure VMs with fzf</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-01-05T19:05:53Z>January 5, 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
2-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/tips/>Tips</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/azure/>Azure</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/aad-login/>AAD Login</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/fzf/>Fzf</a></span></div></div></header><div class=post-content><p><a href=https://learn.microsoft.com/en-us/entra/identity/devices/howto-vm-sign-in-azure-ad-linux class=external-link target=_blank rel=noopener>AAD Login</a> or EntraID login now, is a feature that allows you to login to Azure VMs
using your Entra ID account.</p><p>It requires that you have the Virtual Machine Login or Virtual Machine Administrator Login roles (the former logs you in as a regular user and the latter an administrator).</p><p><a href=https://github.com/junegunn/fzf class=external-link target=_blank rel=noopener>fzf</a> is a command-line fuzzy finder, as the project site states it is an interactive UNIX filter for command-line that can be used with any list, files, etc.</p><p>Two example functions are provided below that use fzf to allow you to interactively select the subscription, VM/VMSS to SSH to.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff7b72>function</span> az_ssh_vmss_instance<span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>AZ_SSH_CFG</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>HOME</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/.azure-sshconfig&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>AZ_SSH_KEYS</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>HOME</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/.azure-sshkeys&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>sub</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>az account list -o table --query <span style=color:#a5d6ff>&#34;[].{Subscription:name}&#34;</span>|fzf --tac<span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>vmss</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>az vmss list -o table --subscription <span style=color:#79c0ff>$sub</span> --query <span style=color:#a5d6ff>&#34;[].{name:name,resourceGroup:resourceGroup,location:location,env:tags.Environment,domain:tags.AuthProxyDomain,usedBy:tags.UsedBy}&#34;</span> | fzf --tac<span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>vmss_name</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>echo <span style=color:#79c0ff>$vmss</span> | awk <span style=color:#a5d6ff>&#39;{print $1}&#39;</span><span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>rg</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>echo <span style=color:#79c0ff>$vmss</span> | awk <span style=color:#a5d6ff>&#39;{print $2}&#39;</span><span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>instance_ip</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>az vmss nic list --resource-group <span style=color:#79c0ff>$rg</span> --vmss-name <span style=color:#79c0ff>$vmss_name</span> --subscription <span style=color:#79c0ff>$sub</span> -o json | jq -r <span style=color:#a5d6ff>&#39;.[].ipConfigurations[].privateIPAddress&#39;</span> | fzf --tac<span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   ssh-keygen -f <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>HOME</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/.ssh/known_hosts&#34;</span> -R <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>instance_ip</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>   az ssh config --ip <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>instance_ip</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> --file <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>AZ_SSH_CFG</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> --keys-destination-folder <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>AZ_SSH_KEYS</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>   az ssh vm --ip <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>instance_ip</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#8b949e;font-style:italic># We can then use SCP like this to copy files to/from the remote vm</span>
</span></span><span style=display:flex><span>   <span style=color:#8b949e;font-style:italic># scp -F ./azure-sshconfig &lt;local file&gt; &lt;vm ip&gt;:~/temp</span>
</span></span><span style=display:flex><span>   <span style=color:#8b949e;font-style:italic># scp -F ./azure-sshconfig &lt;vm ip&gt;:~/some/file &lt;local file&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>function</span> az_ssh_vm<span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>sub</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>az account list -o table --query <span style=color:#a5d6ff>&#34;[].{Subscription:name}&#34;</span>|fzf --tac<span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>vms</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>az vm list -o table --subscription <span style=color:#79c0ff>$sub</span> --query <span style=color:#a5d6ff>&#34;[].{name:name,resourceGroup:resourceGroup,location:location,env:tags.Environment,component:tags.Component,client:tags.Client}&#34;</span> | fzf --tac<span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>vm_name</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>echo <span style=color:#79c0ff>$vms</span> | awk <span style=color:#a5d6ff>&#39;{print $1}&#39;</span><span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>rg</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>echo <span style=color:#79c0ff>$vms</span> | awk <span style=color:#a5d6ff>&#39;{print $2}&#39;</span><span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>nic_id</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>az vm nic list --resource-group <span style=color:#79c0ff>$rg</span> --vm-name <span style=color:#79c0ff>$vm_name</span> --subscription <span style=color:#79c0ff>$sub</span> -o json | jq -r <span style=color:#a5d6ff>&#39;.[].id&#39;</span><span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   <span style=color:#79c0ff>instance_ip</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>az vm nic show --resource-group <span style=color:#79c0ff>$rg</span> --vm-name <span style=color:#79c0ff>$vm_name</span> --subscription <span style=color:#79c0ff>$sub</span> --nic <span style=color:#79c0ff>$nic_id</span> -o json | jq -r <span style=color:#a5d6ff>&#39;.ipConfigurations[].privateIPAddress&#39;</span> | fzf --tac<span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>   az ssh config --file ~/.ssh/config -n <span style=color:#a5d6ff>${</span><span style=color:#79c0ff>vm_name</span><span style=color:#a5d6ff>}</span> -g  <span style=color:#a5d6ff>${</span><span style=color:#79c0ff>rg</span><span style=color:#a5d6ff>}</span> --subscription <span style=color:#a5d6ff>${</span><span style=color:#79c0ff>sub</span><span style=color:#a5d6ff>}</span> --prefer-private-ip
</span></span><span style=display:flex><span>   az ssh vm --ip <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>instance_ip</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Vijay Thakorlal
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>